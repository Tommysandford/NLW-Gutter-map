<!DOCTYPE html>
<html>
<head>
  <title>Asset Location View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      overflow: hidden;
    }

    #appContainer {
      position: relative;
      height: 100vh;
      width: 100vw;
    }

    /* Full-screen map */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    /* Asset info overlay */
    #assetInfo {
      position: fixed;
      top: 12px;
      left: 12px;
      right: 12px;
      z-index: 1000;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 16px;
      max-width: 400px;
      margin: 0 auto;
    }

    #assetInfo h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    #assetInfo p {
      margin: 4px 0;
      font-size: 14px;
      color: #666;
    }

    .asset-detail {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .asset-detail strong {
      color: #333;
    }

    /* Back button */
    #backButton {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 1000;
      background: #34a853;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Floor indicator */
    #floorIndicator {
      position: fixed;
      bottom: 20px;
      left: 12px;
      z-index: 1000;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    /* Zoom controls */
    #zoomControls {
      position: fixed;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .zoom-btn {
      width: 48px;
      height: 48px;
      border: none;
      background: white;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: background 0.2s ease;
    }

    .zoom-btn:hover {
      background: #f8f9fa;
    }

    .zoom-btn + .zoom-btn {
      border-top: 1px solid #eee;
    }

    /* Legend */
    #legend {
      position: fixed;
      bottom: 20px;
      right: 12px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      min-width: 160px;
      max-width: 200px;
    }

    #legend h3 {
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      text-align: center;
      border-bottom: 1px solid #eee;
      padding-bottom: 6px;
    }

    .legend-grid {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      padding: 2px 0;
    }

    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 1px solid #ddd;
    }

    /* Hide default leaflet controls */
    .leaflet-control-zoom {
      display: none;
    }

    .leaflet-control-attribution {
      display: none;
    }

    /* Mobile responsive */
    @media (max-width: 428px) {
      #assetInfo {
        left: 8px;
        right: 8px;
        padding: 12px;
      }

      #backButton {
        top: 8px;
        right: 8px;
        padding: 6px 12px;
        font-size: 13px;
      }

      #floorIndicator {
        bottom: 16px;
        left: 8px;
        padding: 10px 12px;
        font-size: 13px;
      }

      #zoomControls {
        right: 8px;
      }

      .zoom-btn {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }

      #legend {
        bottom: 16px;
        right: 8px;
        padding: 10px;
        min-width: 140px;
        max-width: 180px;
      }
    }

    /* Pulsing animation for highlighted asset */
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .highlighted-marker {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>
  <div id="appContainer">
    <!-- Full screen map -->
    <div id="map"></div>
    
    <!-- Asset info overlay -->
    <div id="assetInfo">
      <h3 id="assetTitle">Asset Details</h3>
      <div class="asset-detail">
        <span>Asset ID:</span>
        <strong id="assetIdDisplay">Loading...</strong>
      </div>
      <div class="asset-detail">
        <span>Category:</span>
        <strong id="categoryDisplay">Loading...</strong>
      </div>
      <div class="asset-detail">
        <span>Building:</span>
        <strong id="buildingDisplay">Loading...</strong>
      </div>
    </div>
    
    <!-- Back button -->
    <button id="backButton" onclick="window.location.href='https://nlw-gutter-cleaning--38x6.glide.page/dl/e531d2'">
      ← Back to Glide
    </button>
    
    <!-- Floor indicator -->
    <div id="floorIndicator">
      Floor: <span id="currentFloor">Loading...</span>
    </div>
    
    <!-- Zoom controls -->
    <div id="zoomControls">
      <button class="zoom-btn" id="zoomIn">+</button>
      <button class="zoom-btn" id="zoomOut">−</button>
    </div>
    
    <!-- Legend -->
    <div id="legend">
      <h3>Legend</h3>
      <div class="legend-grid">
        <div class="legend-item">
          <div class="legend-color" style="background: blue;"></div>
          <span>Gutter</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: red;"></div>
          <span>Down Pipe</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: green;"></div>
          <span>Roof Drain</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: orange;"></div>
          <span>Manhole</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: violet;"></div>
          <span>Ground Channel</span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAkYw8tENd4MoXRpYLE0yjJBRWFvEsgsLk8",
      authDomain: "nlw-gutter-app.firebaseapp.com",
      databaseURL: "https://nlw-gutter-app-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "nlw-gutter-app",
      storageBucket: "nlw-gutter-app.appspot.com",
      messagingSenderId: "457588970392",
      appId: "1:457588970392:web:79b2f4aa13c846d21a11ed",
      measurementId: "G-GCGYETQQV8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const bounds = [[0, 0], [1000, 1500]];
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 3,
      zoomSnap: 0.1,
      zoomDelta: 0.5,
      maxBounds: bounds,
      maxBoundsViscosity: 0.3,
      tap: true,
      tapTolerance: 15,
      touchZoom: true,
      doubleClickZoom: true,
      zoomControl: false
    });

    let currentOverlay;
    let targetAsset = null;
    let highlightedMarker = null;

    const floorBounds = {
      "Main Building": [[0, 0], [1000, 1500]],
      "Outstores and Tech": [[0, 0], [1000, 1500]],
      "TLB": [[0, 0], [1000, 1500]]
    };

    const iconMap = {
      "Gutter": "blue",
      "Down Pipe": "red",
      "Roof Drain": "green",
      "Manhole": "orange",
      "Ground Level Channel": "violet",
      "default": "grey"
    };

    // URL parameter handling
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const assetId = getQueryParam('assetId') || getQueryParam('Asset_ID') || getQueryParam('assetid');
    const building = getQueryParam('building') || getQueryParam('Building_Location') || getQueryParam('area');
    const category = getQueryParam('category') || getQueryParam('Asset_Category');

    console.log('Asset Detail View Parameters:', { assetId, building, category });

    // Building to floor mapping
    const buildingToFloorMapping = {
      "Main Building": { label: "Main Building", image: "Main.jpg" },
      "main building": { label: "Main Building", image: "Main.jpg" },
      "Outstores and Tech": { label: "Outstores and Tech", image: "Outstores and Tech.jpg" },
      "outstores and tech": { label: "Outstores and Tech", image: "Outstores and Tech.jpg" },
      "Third Library Building": { label: "TLB", image: "TLB.jpg" },
      "third library building": { label: "TLB", image: "TLB.jpg" },
      "TLB": { label: "TLB", image: "TLB.jpg" },
      "tlb": { label: "TLB", image: "TLB.jpg" },
      "Book Stack 2": { label: "Outstores and Tech", image: "Outstores and Tech.jpg" }
    };

    function getCategoryIcon(category, isHighlighted = false) {
      const color = iconMap[category] || iconMap["default"];
      const isMobile = window.innerWidth < 768;
      const iconSize = isHighlighted 
        ? (isMobile ? [40, 65] : [35, 57])
        : (isMobile ? [30, 49] : [25, 41]);
      const iconAnchor = isHighlighted
        ? (isMobile ? [20, 65] : [17, 57])
        : (isMobile ? [15, 49] : [12, 41]);
      
      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
        iconSize: iconSize,
        iconAnchor: iconAnchor,
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
    }

    function loadMarkersForFloor(floor) {
      map.eachLayer(layer => {
        if (layer instanceof L.Marker) map.removeLayer(layer);
      });

      const floorRef = db.ref(`bs2_markers/${floor}`);
      
      floorRef.once('value', snapshot => {
        const markers = snapshot.val();
        if (!markers) return;

        let foundTargetAsset = false;

        Object.entries(markers).forEach(([key, data]) => {
          if (typeof data.lat !== "number" || typeof data.lng !== "number" || typeof data.note !== "string") return;
          
          const isTargetAsset = assetId && (
            data.assetId === assetId || 
            data.note.includes(assetId) ||
            key === assetId
          );

          const icon = getCategoryIcon(data.category, isTargetAsset);
          const marker = L.marker([data.lat, data.lng], { icon }).addTo(map);
          
          marker.bindPopup(`
            <div>
              <strong>${data.note}</strong><br>
              <em>Category: ${data.category}</em>
            </div>
          `);

          if (isTargetAsset) {
            foundTargetAsset = true;
            highlightedMarker = marker;
            
            // Center map on this asset
            map.setView([data.lat, data.lng], 1);
            
            // Open popup
            setTimeout(() => {
              marker.openPopup();
            }, 500);

            // Add pulsing animation
            marker.getElement().classList.add('highlighted-marker');

            // Update asset info
            document.getElementById('assetIdDisplay').textContent = assetId;
            document.getElementById('categoryDisplay').textContent = data.category;
            document.getElementById('buildingDisplay').textContent = building || floor;
          } else {
            // Make other markers slightly transparent
            marker.setOpacity(0.6);
          }
        });

        if (!foundTargetAsset && assetId) {
          console.warn('Target asset not found:', assetId);
          // Still show asset info from URL parameters
          document.getElementById('assetIdDisplay').textContent = assetId;
          document.getElementById('categoryDisplay').textContent = category || 'Unknown';
          document.getElementById('buildingDisplay').textContent = building || 'Unknown';
        }
      });
    }

    function loadFloor(imagePath, label) {
      if (currentOverlay) map.removeLayer(currentOverlay);
      const bounds = floorBounds[label] || [[0, 0], [1000, 1500]];
      currentOverlay = L.imageOverlay(imagePath, bounds).addTo(map);
      map.fitBounds(bounds);
      
      document.getElementById('currentFloor').textContent = label;
      
      loadMarkersForFloor(label);
      
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }

    // Determine which floor to load
    let targetFloor = { label: "Main Building", image: "Main.jpg" }; // Default

    if (building && buildingToFloorMapping[building]) {
      targetFloor = buildingToFloorMapping[building];
    } else if (assetId) {
      // Try to determine building from asset ID prefix
      const prefix = assetId.split(' ')[0] || assetId.split('-')[0];
      if (prefix === 'TLB') {
        targetFloor = { label: "TLB", image: "TLB.jpg" };
      } else if (prefix === 'BS2') {
        targetFloor = { label: "Main Building", image: "Main.jpg" };
      }
    }

    console.log('Loading floor:', targetFloor);

    // Load the appropriate floor
    loadFloor(targetFloor.image, targetFloor.label);

    // Zoom controls
    document.getElementById('zoomIn').addEventListener('click', () => {
      map.zoomIn();
    });

    document.getElementById('zoomOut').addEventListener('click', () => {
      map.zoomOut();
    });

    // Handle resize
    window.addEventListener('resize', () => {
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    });

    window.addEventListener('load', () => {
      setTimeout(() => {
        map.invalidateSize();
      }, 200);
    });
  </script>
</body>
</html>
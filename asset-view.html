<!DOCTYPE html>
<html>
<head>
  <title>Asset Location View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      overflow: hidden;
    }

    #appContainer {
      position: relative;
      height: 100vh;
      width: 100vw;
    }

    /* Full-screen map */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    /* Location indicator */
    #locationIndicator {
      position: fixed;
      bottom: 20px;
      left: 12px;
      z-index: 1000;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    /* Zoom controls */
    #zoomControls {
      position: fixed;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .zoom-btn {
      width: 48px;
      height: 48px;
      border: none;
      background: white;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: background 0.2s ease;
    }

    .zoom-btn:hover {
      background: #f8f9fa;
    }

    .zoom-btn + .zoom-btn {
      border-top: 1px solid #eee;
    }

    /* Hide default leaflet controls */
    .leaflet-control-zoom {
      display: none;
    }

    .leaflet-control-attribution {
      display: none;
    }

    /* Mobile responsive */
    @media (max-width: 428px) {
      #locationIndicator {
        bottom: 16px;
        left: 8px;
        padding: 10px 12px;
        font-size: 13px;
      }

      #zoomControls {
        right: 8px;
      }

      .zoom-btn {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
    }

    /* Enhanced pulsing animation for highlighted asset */
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
        filter: drop-shadow(0 0 0 rgba(255, 0, 0, 0.7));
      }
      50% {
        transform: scale(1.3);
        opacity: 0.8;
        filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.8));
      }
      100% {
        transform: scale(1);
        opacity: 1;
        filter: drop-shadow(0 0 0 rgba(255, 0, 0, 0.7));
      }
    }

    .highlighted-marker {
      animation: pulse 2s infinite;
      z-index: 1000 !important;
    }
  </style>
</head>
<body>
  <div id="appContainer">
    <!-- Full screen map -->
    <div id="map"></div>
    
    <!-- Location indicator -->
    <div id="locationIndicator">
      Location: <span id="currentLocation">Loading...</span>
    </div>
    
    <!-- Zoom controls -->
    <div id="zoomControls">
      <button class="zoom-btn" id="zoomIn">+</button>
      <button class="zoom-btn" id="zoomOut">âˆ’</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAkYw8tENd4MoXRpYLE0yjJBRWFvEsgsLk8",
      authDomain: "nlw-gutter-app.firebaseapp.com",
      databaseURL: "https://nlw-gutter-app-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "nlw-gutter-app",
      storageBucket: "nlw-gutter-app.appspot.com",
      messagingSenderId: "457588970392",
      appId: "1:457588970392:web:79b2f4aa13c846d21a11ed",
      measurementId: "G-GCGYETQQV8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const bounds = [[0, 0], [1000, 1500]];
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 3,
      zoomSnap: 0.1,
      zoomDelta: 0.5,
      maxBounds: bounds,
      maxBoundsViscosity: 0.3,
      tap: true,
      tapTolerance: 15,
      touchZoom: true,
      doubleClickZoom: true,
      zoomControl: false
    });

    let currentOverlay;
    let targetAsset = null;
    let highlightedMarker = null;

    // Updated floor bounds for all buildings
    const floorBounds = {
      "Bookstack 1 & 2": [[0, 0], [1000, 1500]],
      "Main Building": [[0, 0], [1000, 1500]],
      "Third Library Building": [[0, 0], [1000, 1500]],
      "Outstores": [[0, 0], [1000, 1500]],
      "Technology & Craftsman Block": [[0, 0], [1000, 1500]]
    };

    const iconMap = {
      "Gutter": "blue",
      "Down Pipe": "red",
      "Roof Drain": "green",
      "Manhole": "orange",
      "Ground Level Channel": "violet",
      "default": "grey"
    };

    // URL parameter handling
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const assetId = getQueryParam('assetId') || getQueryParam('asset');
    const building = getQueryParam('building') || getQueryParam('Building_Location') || getQueryParam('area');
    const category = getQueryParam('category') || getQueryParam('Asset_Category');

    console.log('Asset Detail View Parameters:', { assetId, building, category, fullURL: window.location.href });

    function getCategoryIcon(category, isHighlighted = false) {
      const color = iconMap[category] || iconMap["default"];
      
      // Use consistent icon size regardless of zoom or highlight status
      const iconSize = [25, 41];
      const iconAnchor = [12, 41];
      
      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
        iconSize: iconSize,
        iconAnchor: iconAnchor,
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
    }

    function loadFloor(imagePath, label) {
      if (currentOverlay) map.removeLayer(currentOverlay);
      
      const bounds = floorBounds[label] || [[0, 0], [1000, 1500]];
      
      console.log('ðŸ¢ Loading floor image:', imagePath, 'for location:', label);
      
      currentOverlay = L.imageOverlay(imagePath, bounds, {
        opacity: 1,
        alt: label
      }).addTo(map);
      
      // Wait for image to load before fitting bounds
      currentOverlay.on('load', () => {
        console.log('âœ… Floor image loaded successfully');
        map.fitBounds(bounds);
      });
      
      currentOverlay.on('error', () => {
        console.error('âŒ Failed to load floor image:', imagePath);
      });
      
      document.getElementById('currentLocation').textContent = label;
      
      // Load markers for this floor and find the target asset
      loadMarkersForFloor(label);
      
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }

    function loadMarkersForFloor(floor) {
      // Clear existing markers
      map.eachLayer(layer => {
        if (layer instanceof L.Marker) map.removeLayer(layer);
      });

      const floorRef = db.ref(`bs2_markers/${floor}`);
      
      floorRef.once('value', snapshot => {
        const markers = snapshot.val();
        if (!markers) {
          console.log('No markers found for floor:', floor);
          return;
        }

        let foundTargetAsset = false;

        Object.entries(markers).forEach(([key, data]) => {
          if (typeof data.lat !== "number" || typeof data.lng !== "number" || typeof data.note !== "string") return;
          
          // Check if this is our target asset - look in note field primarily
          const isTargetAsset = assetId && (
            data.note === assetId ||                    // Exact match in note
            data.note.includes(assetId) ||              // Partial match in note  
            data.assetId === assetId ||                 // Match assetId field if it exists
            key === assetId                             // Match the Firebase key
          );

          console.log('Checking marker:', {
            key: key,
            note: data.note,
            assetId: data.assetId,
            coordinates: [data.lat, data.lng],
            searchingFor: assetId,
            isMatch: isTargetAsset
          });

          // Only show the target asset - hide all others
          if (isTargetAsset) {
            foundTargetAsset = true;
            const icon = getCategoryIcon(data.category, true);
            const marker = L.marker([data.lat, data.lng], { 
              icon: icon,
              zIndexOffset: 1000 // Keep marker on top
            }).addTo(map);
            
            marker.bindPopup(`
              <div>
                <strong>${data.note}</strong><br>
                <em>Category: ${data.category}</em><br>
                <em>Location: ${floor}</em>
              </div>
            `);

            highlightedMarker = marker;
            
            // Center map on this asset with proper zoom - wait a bit for image to load
            setTimeout(() => {
              map.setView([data.lat, data.lng], 0.5);
              
              // If still not visible, try fitting bounds around the marker
              setTimeout(() => {
                const markerBounds = L.latLngBounds([data.lat, data.lng], [data.lat, data.lng]);
                map.fitBounds(markerBounds.pad(0.1));
              }, 500);
            }, 300);
            
            // Open popup after centering
            setTimeout(() => {
              marker.openPopup();
            }, 800);

            // Add pulsing animation after the element is rendered
            setTimeout(() => {
              const markerElement = marker.getElement();
              if (markerElement) {
                markerElement.classList.add('highlighted-marker');
              }
            }, 100);

            console.log('âœ… Found and highlighted target asset:', assetId, 'on location:', floor);
          }
        });

        if (!foundTargetAsset && assetId) {
          console.warn('âŒ Target asset not found on location:', floor, 'Asset ID:', assetId);
        }
      });
    }

    // Function to find asset across all floors
    async function findFloorByAssetId(assetId) {
      const floors = ["Bookstack 1 & 2", "Main Building", "Third Library Building", "Outstores", "Technology & Craftsman Block"];
      
      for (const floor of floors) {
        try {
          const snapshot = await db.ref(`bs2_markers/${floor}`).once('value');
          const markers = snapshot.val();
          if (!markers) continue;

          for (const key in markers) {
            const marker = markers[key];
            if (marker.note === assetId || marker.assetId === assetId || key === assetId) {
              console.log('ðŸŽ¯ Found asset', assetId, 'on location:', floor);
              return { floor, image: getImageFromFloor(floor) };
            }
          }
        } catch (error) {
          console.error('Error searching floor:', floor, error);
        }
      }
      return null;
    }

    function getImageFromFloor(floorLabel) {
      const mapping = {
        "Bookstack 1 & 2": "Bookstack%201%20and%202.png",
        "Main Building": "Main.png",
        "Third Library Building": "TLB.png",
        "Outstores": "Outstores.png",
        "Technology & Craftsman Block": "tech%20and%20maintenance%20block.png"
      };
      return mapping[floorLabel] || "Bookstack%201%20and%202.png";
    }

    // Building to floor mapping - updated to match new structure
    const buildingToFloorMapping = {
      // Bookstack 1 & 2 variations
      "Bookstack 1 & 2": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "bookstack 1 & 2": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "Bookstack 1 and 2": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "bookstack 1 and 2": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "BS": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "bs": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "Bookstack": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "bookstack": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      
      // Main Building variations
      "Main Building": { label: "Main Building", image: "Main.png" },
      "main building": { label: "Main Building", image: "Main.png" },
      "Main": { label: "Main Building", image: "Main.png" },
      "main": { label: "Main Building", image: "Main.png" },
      "MB": { label: "Main Building", image: "Main.png" },
      "mb": { label: "Main Building", image: "Main.png" },
      
      // Third Library Building variations
      "Third Library Building": { label: "Third Library Building", image: "TLB.png" },
      "third library building": { label: "Third Library Building", image: "TLB.png" },
      "TLB": { label: "Third Library Building", image: "TLB.png" },
      "tlb": { label: "Third Library Building", image: "TLB.png" },
      "BS3": { label: "Third Library Building", image: "TLB.png" },
      "bs3": { label: "Third Library Building", image: "TLB.png" },
      "Library": { label: "Third Library Building", image: "TLB.png" },
      "library": { label: "Third Library Building", image: "TLB.png" },
      
      // Outstores variations
      "Outstores": { label: "Outstores", image: "Outstores.png" },
      "outstores": { label: "Outstores", image: "Outstores.png" },
      "OS": { label: "Outstores", image: "Outstores.png" },
      "os": { label: "Outstores", image: "Outstores.png" },
      
      // Technology & Craftsman Block variations (combined)
      "Technology & Craftsman Block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "technology & craftsman block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Technology Block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "technology block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Tech Block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "tech block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Technology": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "technology": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Tech": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "tech": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "TB": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "tb": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Craftsman Block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "craftsman block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Craftsman": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "craftsman": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "CB": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "cb": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Tech and Maintenance Block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "tech and maintenance block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" }
    };

    // Initialize the map
    async function initializeMap() {
      let targetFloor = { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" }; // Default

      if (assetId) {
        console.log('ðŸ” Searching for asset:', assetId);
        // Search for the asset across all floors
        const result = await findFloorByAssetId(assetId);
        if (result) {
          targetFloor = { label: result.floor, image: result.image };
          console.log('âœ… Asset found, loading floor:', targetFloor);
        } else {
          console.warn('âŒ Asset not found, using default floor');
        }
      } else if (building && buildingToFloorMapping[building]) {
        targetFloor = buildingToFloorMapping[building];
        console.log('ðŸ¢ Using building parameter:', building, 'â†’', targetFloor);
      }

      // Load the floor
      loadFloor(targetFloor.image, targetFloor.label);
    }

    // Zoom controls
    document.getElementById('zoomIn').addEventListener('click', () => {
      map.zoomIn();
    });

    document.getElementById('zoomOut').addEventListener('click', () => {
      map.zoomOut();
    });

    // Handle resize
    window.addEventListener('resize', () => {
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    });

    window.addEventListener('load', () => {
      setTimeout(() => {
        map.invalidateSize();
      }, 200);
    });

    // Start the application
    initializeMap();
  </script>
</body>
</html>
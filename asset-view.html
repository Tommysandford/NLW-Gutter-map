<!DOCTYPE html>
<html>
<head>
  <title>Asset Location View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      overflow: hidden;
    }

    #appContainer {
      position: relative;
      height: 100vh;
      width: 100vw;
    }

    /* Full-screen map */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    /* Location indicator */
    #locationIndicator {
      position: fixed;
      bottom: 20px;
      left: 12px;
      z-index: 1000;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    /* Asset not found notification */
    #assetNotFoundPanel {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 20px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      display: none;
    }

    #assetNotFoundPanel h3 {
      margin: 0 0 12px 0;
      color: #856404;
      font-size: 16px;
    }

    #assetNotFoundPanel p {
      margin: 0 0 16px 0;
      color: #856404;
      font-size: 14px;
      line-height: 1.4;
    }

    #addAssetBtn {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    #addAssetBtn:hover {
      background: #218838;
    }

    /* Add Asset Panel */
    #addAssetPanel {
      position: fixed;
      bottom: -400px;
      left: 0;
      right: 0;
      z-index: 1002;
      background: white;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      transition: bottom 0.3s ease;
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    #addAssetPanel.show {
      bottom: 0;
    }

    #addAssetPanel h3 {
      margin: 0 0 20px 0;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      color: #333;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }

    .form-group input:focus, .form-group select:focus {
      border-color: #007bff;
      outline: none;
    }

    .form-group input[readonly] {
      background: #f8f9fa;
      color: #6c757d;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    /* Zoom controls */
    #zoomControls {
      position: fixed;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .zoom-btn {
      width: 48px;
      height: 48px;
      border: none;
      background: white;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: background 0.2s ease;
    }

    .zoom-btn:hover {
      background: #f8f9fa;
    }

    .zoom-btn + .zoom-btn {
      border-top: 1px solid #eee;
    }

    .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: #f8f9fa;
    }

    /* Hide default leaflet controls */
    .leaflet-control-zoom {
      display: none;
    }

    .leaflet-control-attribution {
      display: none;
    }

    /* Mobile responsive */
    @media (max-width: 428px) {
      #locationIndicator {
        bottom: 16px;
        left: 8px;
        padding: 10px 12px;
        font-size: 13px;
      }

      #zoomControls {
        right: 8px;
      }

      .zoom-btn {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }

      #assetNotFoundPanel {
        padding: 16px;
        width: 95%;
      }

      #addAssetPanel {
        padding: 16px;
      }
    }

    /* Enhanced pulsing animation for highlighted asset */
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
        filter: drop-shadow(0 0 0 rgba(255, 0, 0, 0.7));
      }
      50% {
        transform: scale(1.3);
        opacity: 0.8;
        filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.8));
      }
      100% {
        transform: scale(1);
        opacity: 1;
        filter: drop-shadow(0 0 0 rgba(255, 0, 0, 0.7));
      }
    }

    .highlighted-marker {
      animation: pulse 2s infinite;
      z-index: 1000 !important;
    }

    /* Add marker mode cursor */
    .add-marker-mode {
      cursor: crosshair !important;
    }

    .add-marker-mode * {
      cursor: crosshair !important;
    }
  </style>
</head>
<body>
  <div id="appContainer">
    <!-- Full screen map -->
    <div id="map"></div>
    
    <!-- Location indicator -->
    <div id="locationIndicator">
      Location: <span id="currentLocation">Loading...</span>
    </div>

    <!-- Asset not found notification -->
    <div id="assetNotFoundPanel">
      <h3>Asset Not Found</h3>
      <p>The asset "<strong id="missingAssetId"></strong>" was not found on this location. Would you like to add it?</p>
      <button id="addAssetBtn">Add Missing Asset</button>
    </div>

    <!-- Add Asset Panel -->
    <div id="addAssetPanel">
      <button class="close-btn" id="closeAddAssetPanel">×</button>
      <h3>Add Missing Asset</h3>
      
      <div class="form-group">
        <label for="assetIdInput">Asset ID</label>
        <input type="text" id="assetIdInput" readonly>
      </div>
      
      <div class="form-group">
        <label for="locationInput">Location</label>
        <input type="text" id="locationInput" readonly>
      </div>
      
      <div class="form-group">
        <label for="categoryInput">Category</label>
        <select id="categoryInput">
          <option value="">-- Select Category --</option>
          <option value="Gutter">Gutter</option>
          <option value="Down Pipe">Down Pipe</option>
          <option value="Roof Drain">Roof Drain</option>
          <option value="Manhole">Manhole</option>
          <option value="Ground Level Channel">Ground Level Channel</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="notesInput">Additional Notes (Optional)</label>
        <input type="text" id="notesInput" placeholder="Enter any additional notes...">
      </div>
      
      <p style="font-size: 14px; color: #6c757d; margin: 16px 0; text-align: center;">
        Click on the map to place the asset marker
      </p>
      
      <div class="button-group">
        <button class="btn btn-secondary" id="cancelAddAsset">Cancel</button>
        <button class="btn btn-primary" id="confirmAddAsset" disabled>Add Asset</button>
      </div>
    </div>
    
    <!-- Zoom controls -->
    <div id="zoomControls">
      <button class="zoom-btn" id="zoomIn">+</button>
      <button class="zoom-btn" id="zoomOut">−</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAkYw8tENd4MoXRpYLE0yjJBRWFvEsgsLk8",
      authDomain: "nlw-gutter-app.firebaseapp.com",
      databaseURL: "https://nlw-gutter-app-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "nlw-gutter-app",
      storageBucket: "nlw-gutter-app.appspot.com",
      messagingSenderId: "457588970392",
      appId: "1:457588970392:web:79b2f4aa13c846d21a11ed",
      measurementId: "G-GCGYETQQV8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const bounds = [[0, 0], [1000, 1500]];
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 3,
      zoomSnap: 0.1,
      zoomDelta: 0.5,
      maxBounds: bounds,
      maxBoundsViscosity: 0.3,
      tap: true,
      tapTolerance: 15,
      touchZoom: true,
      doubleClickZoom: true,
      zoomControl: false
    });

    let currentOverlay;
    let targetAsset = null;
    let highlightedMarker = null;
    let currentFloor = null;
    let addingAssetMode = false;
    let pendingAssetLocation = null;

    // Updated floor bounds for all buildings
    const floorBounds = {
      "Bookstack 1 & 2": [[0, 0], [1000, 1500]],
      "Main Building": [[0, 0], [1000, 1500]],
      "Third Library Building": [[0, 0], [1000, 1500]],
      "Outstores": [[0, 0], [1000, 1500]],
      "Technology & Craftsman Block": [[0, 0], [1000, 1500]]
    };

    const iconMap = {
      "Gutter": "blue",
      "Down Pipe": "red",
      "Roof Drain": "green",
      "Manhole": "orange",
      "Ground Level Channel": "violet",
      "default": "grey"
    };

    // URL parameter handling
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const assetId = getQueryParam('assetId') || getQueryParam('asset');
    const building = getQueryParam('building') || getQueryParam('Building_Location') || getQueryParam('area');
    const category = getQueryParam('category') || getQueryParam('Asset_Category');

    console.log('Asset Detail View Parameters:', { assetId, building, category, fullURL: window.location.href });

    function getCategoryIcon(category, isHighlighted = false) {
      const color = iconMap[category] || iconMap["default"];
      
      // Use consistent icon size regardless of zoom or highlight status
      const iconSize = [25, 41];
      const iconAnchor = [12, 41];
      
      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
        iconSize: iconSize,
        iconAnchor: iconAnchor,
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
    }

    function loadFloor(imagePath, label) {
      if (currentOverlay) map.removeLayer(currentOverlay);
      
      const bounds = floorBounds[label] || [[0, 0], [1000, 1500]];
      currentFloor = label;
      
      console.log('🏢 Loading floor image:', imagePath, 'for location:', label);
      
      currentOverlay = L.imageOverlay(imagePath, bounds, {
        opacity: 1,
        alt: label
      }).addTo(map);
      
      // Wait for image to load before fitting bounds
      currentOverlay.on('load', () => {
        console.log('✅ Floor image loaded successfully');
        map.fitBounds(bounds);
      });
      
      currentOverlay.on('error', () => {
        console.error('❌ Failed to load floor image:', imagePath);
      });
      
      document.getElementById('currentLocation').textContent = label;
      
      // Load markers for this floor and find the target asset
      loadMarkersForFloor(label);
      
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }

    function loadMarkersForFloor(floor) {
      // Clear existing markers
      map.eachLayer(layer => {
        if (layer instanceof L.Marker) map.removeLayer(layer);
      });

      const floorRef = db.ref(`bs2_markers/${floor}`);
      
      floorRef.once('value', snapshot => {
        const markers = snapshot.val();
        if (!markers) {
          console.log('No markers found for floor:', floor);
          if (assetId) {
            showAssetNotFound();
          }
          return;
        }

        let foundTargetAsset = false;

        Object.entries(markers).forEach(([key, data]) => {
          if (typeof data.lat !== "number" || typeof data.lng !== "number" || typeof data.note !== "string") return;
          
          // Check if this is our target asset - look in note field primarily
          const isTargetAsset = assetId && (
            data.note === assetId ||                    // Exact match in note
            data.note.includes(assetId) ||              // Partial match in note  
            data.assetId === assetId ||                 // Match assetId field if it exists
            key === assetId                             // Match the Firebase key
          );

          console.log('Checking marker:', {
            key: key,
            note: data.note,
            assetId: data.assetId,
            coordinates: [data.lat, data.lng],
            searchingFor: assetId,
            isMatch: isTargetAsset
          });

          // Only show the target asset - hide all others
          if (isTargetAsset) {
            foundTargetAsset = true;
            const icon = getCategoryIcon(data.category, true);
            const marker = L.marker([data.lat, data.lng], { 
              icon: icon,
              zIndexOffset: 1000 // Keep marker on top
            }).addTo(map);
            
            marker.bindPopup(`
              <div>
                <strong>${data.note}</strong><br>
                <em>Category: ${data.category}</em><br>
                <em>Location: ${floor}</em>
              </div>
            `);

            highlightedMarker = marker;
            
            // Center map on this asset with proper zoom - wait a bit for image to load
            setTimeout(() => {
              map.setView([data.lat, data.lng], 0.5);
              
              // If still not visible, try fitting bounds around the marker
              setTimeout(() => {
                const markerBounds = L.latLngBounds([data.lat, data.lng], [data.lat, data.lng]);
                map.fitBounds(markerBounds.pad(0.1));
              }, 500);
            }, 300);
            
            // Open popup after centering
            setTimeout(() => {
              marker.openPopup();
            }, 800);

            // Add pulsing animation after the element is rendered
            setTimeout(() => {
              const markerElement = marker.getElement();
              if (markerElement) {
                markerElement.classList.add('highlighted-marker');
              }
            }, 100);

            console.log('✅ Found and highlighted target asset:', assetId, 'on location:', floor);
          }
        });

        if (!foundTargetAsset && assetId) {
          console.warn('❌ Target asset not found on location:', floor, 'Asset ID:', assetId);
          showAssetNotFound();
        }
      });
    }

    function showAssetNotFound() {
      document.getElementById('missingAssetId').textContent = assetId;
      document.getElementById('assetNotFoundPanel').style.display = 'block';
    }

    function hideAssetNotFound() {
      document.getElementById('assetNotFoundPanel').style.display = 'none';
    }

    // Function to find asset across all floors
    async function findFloorByAssetId(assetId) {
      const floors = ["Bookstack 1 & 2", "Main Building", "Third Library Building", "Outstores", "Technology & Craftsman Block"];
      
      for (const floor of floors) {
        try {
          const snapshot = await db.ref(`bs2_markers/${floor}`).once('value');
          const markers = snapshot.val();
          if (!markers) continue;

          for (const key in markers) {
            const marker = markers[key];
            if (marker.note === assetId || marker.assetId === assetId || key === assetId) {
              console.log('🎯 Found asset', assetId, 'on location:', floor);
              return { floor, image: getImageFromFloor(floor) };
            }
          }
        } catch (error) {
          console.error('Error searching floor:', floor, error);
        }
      }
      return null;
    }

    function getImageFromFloor(floorLabel) {
      const mapping = {
        "Bookstack 1 & 2": "Bookstack%201%20and%202.png",
        "Main Building": "Main.png",
        "Third Library Building": "TLB.png",
        "Outstores": "Outstores.png",
        "Technology & Craftsman Block": "tech%20and%20maintenance%20block.png"
      };
      return mapping[floorLabel] || "Bookstack%201%20and%202.png";
    }

    // Building to floor mapping - updated to match new structure
    const buildingToFloorMapping = {
      // Bookstack 1 & 2 variations
      "Bookstack 1 & 2": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "bookstack 1 & 2": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "Bookstack 1 and 2": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "bookstack 1 and 2": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "BS": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "bs": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "Bookstack": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      "bookstack": { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" },
      
      // Main Building variations
      "Main Building": { label: "Main Building", image: "Main.png" },
      "main building": { label: "Main Building", image: "Main.png" },
      "Main": { label: "Main Building", image: "Main.png" },
      "main": { label: "Main Building", image: "Main.png" },
      "MB": { label: "Main Building", image: "Main.png" },
      "mb": { label: "Main Building", image: "Main.png" },
      
      // Third Library Building variations
      "Third Library Building": { label: "Third Library Building", image: "TLB.png" },
      "third library building": { label: "Third Library Building", image: "TLB.png" },
      "TLB": { label: "Third Library Building", image: "TLB.png" },
      "tlb": { label: "Third Library Building", image: "TLB.png" },
      "BS3": { label: "Third Library Building", image: "TLB.png" },
      "bs3": { label: "Third Library Building", image: "TLB.png" },
      "Library": { label: "Third Library Building", image: "TLB.png" },
      "library": { label: "Third Library Building", image: "TLB.png" },
      
      // Outstores variations
      "Outstores": { label: "Outstores", image: "Outstores.png" },
      "outstores": { label: "Outstores", image: "Outstores.png" },
      "OS": { label: "Outstores", image: "Outstores.png" },
      "os": { label: "Outstores", image: "Outstores.png" },
      
      // Technology & Craftsman Block variations (combined)
      "Technology & Craftsman Block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "technology & craftsman block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Technology Block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "technology block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Tech Block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "tech block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Technology": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "technology": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Tech": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "tech": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "TB": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "tb": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Craftsman Block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "craftsman block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Craftsman": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "craftsman": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "CB": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "cb": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "Tech and Maintenance Block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" },
      "tech and maintenance block": { label: "Technology & Craftsman Block", image: "tech%20and%20maintenance%20block.png" }
    };

    // Initialize the map
    async function initializeMap() {
      let targetFloor = { label: "Bookstack 1 & 2", image: "Bookstack%201%20and%202.png" }; // Default

      if (assetId) {
        console.log('🔍 Searching for asset:', assetId);
        // Search for the asset across all floors
        const result = await findFloorByAssetId(assetId);
        if (result) {
          targetFloor = { label: result.floor, image: result.image };
          console.log('✅ Asset found, loading floor:', targetFloor);
        } else {
          console.warn('❌ Asset not found, using default floor');
        }
      } else if (building && buildingToFloorMapping[building]) {
        targetFloor = buildingToFloorMapping[building];
        console.log('🏢 Using building parameter:', building, '→', targetFloor);
      }

      // Load the floor
      loadFloor(targetFloor.image, targetFloor.label);
    }

    // Add Asset Functionality
    function initializeAddAssetForm() {
      document.getElementById('assetIdInput').value = assetId || '';
      document.getElementById('locationInput').value = currentFloor || '';
      
      // Pre-select category if provided
      if (category) {
        const categorySelector = document.getElementById('categoryInput');
        const categoryMap = {
          "Roof Drain": "Roof Drain",
          "roof drain": "Roof Drain",
          "Gutter": "Gutter", 
          "gutter": "Gutter",
          "Down Pipe": "Down Pipe",
          "down pipe": "Down Pipe",
          "Ground Level Channel": "Ground Level Channel",
          "ground level channel": "Ground Level Channel",
          "Manhole": "Manhole",
          "manhole": "Manhole"
        };
        
        const mappedCategory = categoryMap[category] || category;
        categorySelector.value = mappedCategory;
      }
    }

    function showAddAssetPanel() {
      hideAssetNotFound();
      initializeAddAssetForm();
      document.getElementById('addAssetPanel').classList.add('show');
      addingAssetMode = true;
      document.body.classList.add('add-marker-mode');
      pendingAssetLocation = null;
      document.getElementById('confirmAddAsset').disabled = true;
    }

    function hideAddAssetPanel() {
      document.getElementById('addAssetPanel').classList.remove('show');
      addingAssetMode = false;
      document.body.classList.remove('add-marker-mode');
      pendingAssetLocation = null;
    }

    function saveNewAsset() {
      if (!pendingAssetLocation) {
        alert('Please click on the map to select a location for the asset.');
        return;
      }

      const assetIdValue = document.getElementById('assetIdInput').value.trim();
      const categoryValue = document.getElementById('categoryInput').value;
      const notesValue = document.getElementById('notesInput').value.trim();

      if (!assetIdValue) {
        alert('Asset ID is required.');
        return;
      }

      if (!categoryValue) {
        alert('Please select a category.');
        return;
      }

      // Create the note field - combining asset ID with any additional notes
      let noteText = assetIdValue;
      if (notesValue) {
        noteText += ` - ${notesValue}`;
      }

      const newAsset = {
        lat: pendingAssetLocation.lat,
        lng: pendingAssetLocation.lng,
        note: noteText,
        assetId: assetIdValue,
        category: categoryValue,
        addedDate: new Date().toISOString()
      };

      console.log('Saving new asset:', newAsset);

      // Save to Firebase
      db.ref(`bs2_markers/${currentFloor}`).push(newAsset)
        .then(() => {
          console.log('✅ Asset saved successfully');
          alert('Asset added successfully!');
          hideAddAssetPanel();
          
          // Reload the markers to show the new asset
          setTimeout(() => {
            loadMarkersForFloor(currentFloor);
          }, 500);
        })
        .catch((error) => {
          console.error('❌ Error saving asset:', error);
          alert('Error saving asset. Please try again.');
        });
    }

    // Event Listeners
    document.getElementById('addAssetBtn').addEventListener('click', showAddAssetPanel);
    document.getElementById('closeAddAssetPanel').addEventListener('click', hideAddAssetPanel);
    document.getElementById('cancelAddAsset').addEventListener('click', hideAddAssetPanel);
    document.getElementById('confirmAddAsset').addEventListener('click', saveNewAsset);

    // Category selection validation
    document.getElementById('categoryInput').addEventListener('change', (e) => {
      updateConfirmButton();
    });

    function updateConfirmButton() {
      const categorySelected = document.getElementById('categoryInput').value;
      const locationSelected = pendingAssetLocation !== null;
      
      document.getElementById('confirmAddAsset').disabled = !(categorySelected && locationSelected);
    }

    // Map click handler for adding assets
    map.on('click', (e) => {
      if (!addingAssetMode) return;
      
      // Remove any existing temporary marker
      map.eachLayer(layer => {
        if (layer.options && layer.options.isTemporary) {
          map.removeLayer(layer);
        }
      });

      // Add temporary marker
      const tempIcon = getCategoryIcon(document.getElementById('categoryInput').value || 'default');
      const tempMarker = L.marker([e.latlng.lat, e.latlng.lng], { 
        icon: tempIcon,
        isTemporary: true,
        zIndexOffset: 500
      }).addTo(map);

      tempMarker.bindPopup('Proposed location for new asset').openPopup();

      // Store the location
      pendingAssetLocation = e.latlng;
      updateConfirmButton();

      console.log('Selected location:', e.latlng);
    });

    // Update temporary marker when category changes
    document.getElementById('categoryInput').addEventListener('change', (e) => {
      if (pendingAssetLocation) {
        // Remove existing temporary marker
        map.eachLayer(layer => {
          if (layer.options && layer.options.isTemporary) {
            map.removeLayer(layer);
          }
        });

        // Add new temporary marker with correct icon
        const tempIcon = getCategoryIcon(e.target.value || 'default');
        const tempMarker = L.marker([pendingAssetLocation.lat, pendingAssetLocation.lng], { 
          icon: tempIcon,
          isTemporary: true,
          zIndexOffset: 500
        }).addTo(map);

        tempMarker.bindPopup('Proposed location for new asset').openPopup();
      }
    });

    // Zoom controls
    document.getElementById('zoomIn').addEventListener('click', () => {
      map.zoomIn();
    });

    document.getElementById('zoomOut').addEventListener('click', () => {
      map.zoomOut();
    });

    // Handle resize
    window.addEventListener('resize', () => {
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    });

    window.addEventListener('load', () => {
      setTimeout(() => {
        map.invalidateSize();
      }, 200);
    });

    // Start the application
    initializeMap();